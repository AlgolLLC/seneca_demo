// mingo.js 2.0.3
// Copyright (c) 2017 Francis Asante
// MIT
!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.mingo=t()}(this,function(){"use strict";function n(n,t){_(n)&&w(t)}function t(n){switch(u(n)){case Qn:case Wn:return N(n,t);default:return n}}function e(n){switch(u(n)){case Qn:return L([],n);case Wn:return Object.assign({},n);default:return n}}function r(n){return null===n?"Null":void 0===n?"Undefined":n.constructor.name}function u(n){return r(n).toLowerCase()}function i(n){return u(n)===Jn}function o(n){return u(n)===Hn}function a(n){return u(n)===zn}function s(n){return u(n)===Qn}function c(n){return!d(n)&&k(n,"length")}function l(n){return u(n)===Wn}function f(n){return n===Object(n)}function v(n){return u(n)===Vn}function h(n){return u(n)===Kn}function p(n){return u(n)===Gn}function d(n){return $(n)||g(n)}function $(n){return u(n)===Fn}function g(n){return u(n)===Yn}function m(n,t){return n.some(C.bind(null,t))}function y(n,t){return!m(n,t)}function b(n){return!!n}function _(n){return!n}function x(n){return d(n)||s(n)&&0===n.length||l(n)&&0===j(n).length||!n}function O(n){return s(n)?n:[n]}function k(n,t){return n.hasOwnProperty(t)}function w(n){throw new Error(n)}function j(n){return Object.keys(n)}function M(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(n(t===Object(t),"Cannot iterate over object of type '"+u(t)+"'"),c(t))for(var i=0,o=t.length;i<o&&!1!==e.call(r,t[i],i,t);i++);else for(var a in t)if(k(t,a)&&!1===e.call(r,t[a],a,t))break}function N(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(s(n))return n.map(t,e);if(l(n)){var r={};return M(n,function(n,u){r[u]=t.call(e,n,u)},n),r}}function A(n,t,e){return s(n)?n.reduce(t,e):(M(n,function(r,u){return e=t(e,r,u,n)}),e)}function E(n,t){return n.filter(m.bind(null,t))}function I(n,t){return L(L([],n),t.filter(y.bind(null,n)))}function S(t){function e(n,t){for(var r=0,i=n.length;r<i;r++)s(n[r])&&(t>0||t<0)?e(n[r],Math.max(-1,t-1)):u.push(n[r])}var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;n(s(t),"Input must be an Array");var u=[];return e(t,r),u}function q(n,t){if(t<1)return n;for(;t--&&s(n)&&1===n.length;)n=n[0];return n}function C(n,t){for(var e=[n],r=[t];e.length>0;)if(n=e.pop(),t=r.pop(),n!==t){var i=u(n);if(i!==u(t)||i===Gn)return!1;switch(i){case Qn:if(n.length!==t.length)return!1;L(e,n),L(r,t);break;case Wn:var o=j(n),a=j(t);if(o.length!==a.length)return!1;o.sort(),a.sort();for(var s=0,c=o.length;s<c;s++){var l=o[s];if(l!==a[s])return!1;e.push(n[l]),r.push(t[l])}break;default:if(T(n)!==T(t))return!1}}return 0===e.length}function P(n){var t={},e=[];return M(n,function(n){var r=R(n);k(t,r)||(e.push(n),t[r]=0)}),e}function T(n){var t=u(n);switch(t){case Jn:case zn:case Kn:return n.toString();case Hn:return JSON.stringify(n);case Vn:return n.toISOString();case Fn:case Yn:return t;case Qn:return"["+N(n,T)+"]";default:var e=t===Wn?"":""+r(n),i=j(n);return i.sort(),e+"{"+N(i,function(t){return T(t)+":"+T(n[t])})+"}"}}function R(n){for(var t=0,e=T(n),r=e.length;r;)t=(t<<5)-t^e.charCodeAt(--r);return t>>>0}function U(n,t){for(var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r={},u=[],i=n.length,o=[],a=0;a<i;a++){var s=n[a],c=t.call(e,s,a);if(d(c))o.push(s);else{var l=R(s);k(r,l)||(r[l]=[c,a]),u.push(s)}}return u.sort(function(n,t){var e=r[R(n)],u=r[R(t)];return e[0]<u[0]?-1:e[0]>u[0]?1:e[1]<u[1]?-1:e[1]>u[1]?1:0}),L(o,u)}function D(n,t,e){var r={keys:[],groups:[]},u={};return M(n,function(n){var i=t.call(e,n),o=R(i),a=-1;g(u[o])&&(a=r.keys.length,u[o]=a,r.keys.push(i),r.groups.push([])),a=u[o],r.groups[a].push(n)}),r}function L(n,t){return Array.prototype.push.apply(n,t),n}function B(n,t){for(var e=0,r=n.length-1;e<=r;){var u=Math.round(e+(r-e)/2);if(t<n[u])r=u-1;else{if(!(t>n[u]))return u;e=u+1}}return e}function F(n){var t=this;return function(e){return function(){for(var r=arguments.length,u=Array(r),i=0;i<r;i++)u[i]=arguments[i];var o=R(u);return k(e,o)||(e[o]=n.apply(t,u)),e[o]}}({})}function Y(n,e){var r=j(e);return 0===r.length?n:N(n,function(n){var u=t(n);return M(r,function(t){var r=Rn(n,e[t]);Cn(u,t,r)}),u})}function J(t,e){var u=e.boundaries,i=e.default,o=u[0],a=u[u.length-1],s=e.output||{count:{$sum:1}};n(u.length>2,"$bucket 'boundaries' expression must have at least 3 elements");for(var c=r(o),l=0,f=u.length-1;l<f;l++)n(c===r(u[l+1]),"$bucket 'boundaries' must all be of the same type"),n(u[l]<u[l+1],"$bucket 'boundaries' must be sorted in ascending order");!d(i)&&r(e.default)===r(o)&&n(o>e.default||a<e.default,"$bucket 'default' expression must be out of boundaries range");var v={};return M(u,function(n){return v[n]=[]}),d(i)||(v[i]=[]),M(t,function(t){var r=Rn(t,e.groupBy);if(d(r)||r<o||r>=a)n(!d(i),"$bucket require a default for out of range values"),v[i].push(t);else{n(r>=o&&r<a,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");var s=B(u,r),c=u[Math.max(0,s-1)];v[c].push(t)}}),u.pop(),d(i)||u.push(i),N(u,function(n){var t=En(v[n],null,s);return Object.assign(t,{_id:n})})}function z(t,e){var r=e.output||{count:{$sum:1}},u=e.groupBy,i=e.buckets;n(i>0,"The $bucketAuto 'buckets' field must be greater than 0, but found: "+i);for(var o=Math.max(1,Math.round(t.length/i)),a=F(Rn),s={},c=[],l=U(t,function(n){var t=a(n,u);return d(t)?c.push(n):(s[t]||(s[t]=[]),s[t].push(n)),t}),f=Nn(),v=[],h=0,p=0,$=l.length;p<i&&h<$;p++){for(var g={},m=[],y=0;y<o&&h<$;y++){var b=a(l[h],u);if(d(b)&&(b=null),L(m,d(b)?c:s[b]),h+=d(b)?c.length:s[b].length,k(g,"min")||(g.min=b),v.length>0){v[v.length-1][f].max=g.min}}p==i-1&&L(m,l.slice(h)),v.push(Object.assign(En(m,null,r),{_id:g}))}return v.length>0&&(v[v.length-1][f].max=a(l[l.length-1],u)),v}function H(t,e){n(o(e)&&""!==e.trim()&&-1===e.indexOf(".")&&"$"!==e.trim()[0],"Invalid expression value for $count");var r={};return r[e]=t.length,r}function V(n,t){return N(t,function(t){return sn(n,t)})}function K(n,t){var e=Nn(),r=t[e],u=D(n,function(n){return Rn(n,r,r)}),i=[];return delete t[e],M(u.keys,function(n,r){var o={};g(n)||(o[e]=n),M(t,function(n,t){o[t]=En(u.groups[r],t,n)}),i.push(o)}),i}function Q(n,t){return n.slice(0,t)}function W(t,r){function u(n){return R(d(n)?null:n)}var i=r.from,a=r.localField,c=r.foreignField,l=r.as;n(s(i)&&o(c)&&o(a)&&o(l),"$lookup: invalid argument");var f={};return M(i,function(n){var t=u(n[c]);f[t]=f[t]||[],f[t].push(n)}),N(t,function(n){var t=u(n[a]),r=e(n);return r[l]=f[t]||[],r})}function G(n,t){return new vt(t).find(n).all()}function X(t,e){return n(s(e),"$out: argument must be an array"),L(e,t),t}function Z(e,r){if(x(r))return e;var u=[],i=j(r),s=!1,c=Nn(),f=[!1,!1];if(M(r,function(t,e){e!==c&&(0===t||!1===t?f[0]=!0:f[1]=!0,n(f[0]!==f[1],"Projection cannot have a mix of inclusion and exclusion."))}),m(i,c)){var v=r[c];0!==v&&!1!==v||(i=i.filter(y.bind(null,[c])),n(y(i,c),"Must not contain collections id key"),s=x(i))}else i.push(c);return M(e,function(n){var e={},f=!1,v=!1,h=[];s&&h.push(c),M(i,function(t){var u=r[t],i=void 0;if(t!==c&&m([0,!1],u)&&(v=!0),t===c&&x(u))i=n[t];else if(o(u))i=Rn(n,u,t);else if(m([1,!0],u));else{if(!l(u))return void h.push(t);var s=j(u);s=!(s.length>1)&&s[0],m(wn(tt),s)?"$slice"===s?O(u[s]).every(a)?(i=rt[s](n,u[s],t),f=!0):i=Rn(n,u,t):i=rt[s](n,u[s],t):i=Rn(n,u,t)}var p=Sn(n,t);g(p)||Object.assign(e,p),y([0,1,!1,!0],u)&&(g(i)?Pn(e,t):Cn(e,t,i))}),(f||v||s)&&(e=Object.assign({},n,e),h.length>0&&(e=t(e),M(h,function(n){return Pn(e,n)}))),u.push(e)}),u}function nn(n,e){return N(n,function(n){return Ln(t(n),e)})}function tn(t,e){return N(t,function(t){return t=Rn(t,e.newRoot),n(l(t),"$replaceRoot expression must return an object"),t})}function en(t,e){var r=e.size;n(a(r),"$sample size must be a positive integer");for(var u=[],i=t.length,o=0;o<r;o++){var s=Math.floor(Math.random()*i);u.push(t[s])}return u}function rn(n,t){return n.slice(t)}function un(n,t){if(!x(t)&&l(t)){M(j(t).reverse(),function(e){var r=D(n,function(n){return In(n,e)}),u={},i=function(n){return u[R(n)]},o=U(r.keys,function(n,t){return u[R(n)]=t,n});-1===t[e]&&o.reverse(),n=[],M(o,function(t){return L(n,r.groups[i(t)])})})}return n}function on(n,t){var e={count:{$sum:1}};return e[Nn()]=t,this.$sort(this.$group(n,e),{count:-1})}function an(n,t){o(t)&&(t={path:t});var r=t.path.substr(1),u=t.includeArrayIndex||!1,i=t.preserveNullAndEmptyArrays||!1,a=[],c=function(n,t){!1!==u&&(n[u]=t),a.push(n)};return M(n,function(n){var t=An(n,r);if(s(t))if(0===t.length&&!0===i){var u=e(n);delete u[r],c(u,null)}else M(t,function(t,u){var i=e(n);i[r]=t,c(i,u)});else x(t)&&!0!==i||c(e(n),null)}),a}function sn(t,e){return n(s(e),"Aggregation pipeline must be an array"),new at(e).run(t)}function cn(n,t){return P(this.$push(n,t))}function ln(n,t){var e=this.$push(n,t).filter(a);return A(e,function(n,t){return n+t},0)/(e.length||1)}function fn(n,t){return n.length>0?Rn(n[0],t):void 0}function vn(n,t){return n.length>0?Rn(n[n.length-1],t):void 0}function hn(n,t){return A(this.$push(n,t),function(n,t){return d(n)||t>n?t:n},void 0)}function pn(n,t){return A(this.$push(n,t),function(n,t){return d(n)||t<n?t:n},void 0)}function dn(n,t){return d(t)?n:N(n,function(n){return Rn(n,t)})}function $n(n,t){return Dn({data:this.$push(n,t).filter(a),sampled:!1})}function gn(n,t){return Dn({data:this.$push(n,t).filter(a),sampled:!0})}function mn(n,t){return s(n)?a(t)?n.length*t:A(this.$push(n,t).filter(a),function(n,t){return n+t},0):0}function yn(n,t){return r(n)===r(t)}function bn(n,t,e){return new vt(t).find(n,e)}function _n(n,t){return new vt(t).remove(n)}function xn(n,t){return new Array(Math.max(t-String(n).length+1,0)).join("0")+n}function On(n){if(n<128)return[n];for(var t=n<2048&&1||n<65536&&2||3,e=Ot[t-1],r=[(n>>6*t)+e];t>0;)r.push(128|n>>6*--t&63);return r}function kn(n){for(var t=[],e=0,r=n.length;e<r;e++)t.push(On(n.codePointAt(e)));return t}function wn(){return A(arguments,function(n,t){return L(n,j(jt[t]))},[])}function jn(t,e){var r=e(Bn());n(k(jt,t),"Invalid operator class "+t);var u=jt[t];M(r,function(e,r){n(/^\$\w+$/.test(r),"Invalid operator name "+r),n(!k(u,r),r+" already exists for '"+t+"' operators")});var o={};switch(t){case et:M(r,function(t,e){o[e]=function(t,r){return function(u,o){return{test:function(a){var s=In(a,u),c=t.call(r,u,s,o);return n(i(c),e+" must return a boolean"),c}}}}(t,r)});break;case tt:M(r,function(n,t){o[t]=function(n,t){return function(e,r,u){var i=In(e,u);return n.call(t,u,i,r)}}(n,r)});break;default:M(r,function(n,t){o[t]=function(n,t){return function(){for(var e=arguments.length,r=Array(e),u=0;u<e;u++)r[u]=arguments[u];return n.apply(t,r)}}(n,r)})}Object.assign(jt[t],o)}function Mn(n){Object.assign(Mt,n||{})}function Nn(){return Mt.key}function An(n,t){return f(n)?n[t]:void 0}function En(t,e,r){if(m(wn(nt),e))return st[e](t,r);if(l(r)){var u={};return M(r,function(e,i){if(u[i]=En(t,i,r[i]),m(wn(nt),i))return u=u[i],n(1===j(r).length,"Invalid $group expression '"+JSON.stringify(r)+"'"),!1}),u}}function In(n,t,e){function r(n,t){for(var e=n,i=0;i<t.length;i++){var o=t[i];if(null===o.match(/^\d+$/)&&s(e)){if(0===i&&u>0)break;u+=1,t=t.slice(i),e=A(e,function(n,e){var u=r(e,t);return void 0!==u&&n.push(u),n},[]);break}if(void 0===(e=An(e,o)))break}return e}var u=0;return e=e||{meta:!1},n=r(n,t.split(".")),e.meta?{result:n,depth:u}:n}function Sn(t,e){var r=e.split("."),u=r[0],i=1===r.length||r.slice(1).join("."),o=null!==u.match(/^\d+$/),a=r.length>1,c=void 0,l=void 0;try{s(t)?o?(c=An(t,u),a&&(c=Sn(c,i)),n(!g(c)),c=[c]):(c=[],M(t,function(n){void 0!==(l=Sn(n,e))&&c.push(l)}),n(c.length>0)):(l=An(t,u),a&&(l=Sn(l,i)),n(void 0!==l),c={},c[u]=l)}catch(n){c=void 0}return c}function qn(n,t,e){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],u=t.split("."),i=u[0],o=1===u.length||u.slice(1).join(".");if(1===u.length)e(n,i);else if(s(n)&&!/^\d+$/.test(i))M(n,function(n){qn(n,t,e,r)});else{if(!0===r){var a=k(n,i);a&&!d(n[i])||(n[i]={})}qn(n[i],o,e,r)}}function Cn(n,t,e){qn(n,t,function(n,t){n[t]=e},!0)}function Pn(n,t){qn(n,t,function(n,t){s(n)&&/^\d+$/.test(t)?n.splice(parseInt(t),1):l(n)&&delete n[t]})}function Tn(n){if(m(Xn,u(n)))return h(n)?{$regex:n}:{$eq:n};if(f(n)){var t=j(n);if(0===E(wn(et),t).length)return{$eq:n};if(m(t,"$regex")){var e=n.$regex,r=n.$options||"",i="";o(e)&&(i+=e.ignoreCase||r.indexOf("i")>=0?"i":"",i+=e.multiline||r.indexOf("m")>=0?"m":"",i+=e.global||r.indexOf("g")>=0?"g":"",e=new RegExp(e,i)),n.$regex=e,delete n.$options}}return n}function Rn(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(i.root=i.root||t,m(wn(Zn),r))return wt[r](t,e,i);if(m(wn(nt),r))return t=Rn(t,e,null,i),n(s(t),r+" expression must resolve to an array"),st[r](t,null,i);if(o(e)&&e.length>0&&"$"===e[0]){if(m(Et,e))return Nt[e](t,null,i);if(m(It,e))return e;var a=Et.filter(function(n){return 0===e.indexOf(n+".")});return 1===a.length&&(a=a[0],"$$ROOT"===a&&(t=i.root),e=e.substr(a.length)),In(t,e.slice(1))}switch(u(e)){case Qn:return e.map(function(n){return Rn(t,n)});case Wn:var c={};return M(e,function(r,u){if(c[u]=Rn(t,r,u,i),m(wn(Zn,nt),u))return n(1===j(e).length,"Invalid aggregation expression '"+JSON.stringify(e)+"'"),c=c[u],!1}),c;default:return e}}function Un(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return d(r)?e<0?(e=Math.max(0,t.length+e),r=t.length-e+1):(r=e,e=0):(e<0&&(e=Math.max(0,t.length+e)),n(r>0,"Invalid argument value for $slice operator. Limit must be a positive number"),r+=e),t.slice(e,r)}function Dn(n){var t=A(n.data,function(n,t){return n+t},0),e=n.data.length||1,r=n.sampled&&1||0,u=t/e;return Math.sqrt(A(n.data,function(n,t){return n+Math.pow(t-u,2)},0)/(e-r))}function Ln(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.root=e.root||n;var r=Rn(n,t,null,e);return m(It,r)?At[r](n,t,e):r}function Bn(){return{assert:n,computeValue:Rn,clone:e,cloneDeep:t,each:M,err:w,getHash:R,getType:r,has:k,idKey:Nn,includes:m.bind(null),isArray:s,isBoolean:i,isDate:v,isEmpty:x,isEqual:C,isFunction:p,isNil:d,isNull:$,isNumber:a,isObject:l,isRegExp:h,isString:o,isUndefined:g,keys:j,map:N,ops:wn,resolve:In,resolveObj:Sn,reduce:A}}var Fn="null",Yn="undefined",Jn="boolean",zn="number",Hn="string",Vn="date",Kn="regexp",Qn="array",Wn="object",Gn="function",Xn=[Fn,Yn,Jn,zn,Hn,Vn,Kn],Zn="expression",nt="group",tt="projection",et="query",rt={$:function(n,t,e){w("$ not implemented")},$elemMatch:function(t,e,r){var u=In(t,r),i=new vt(e);n(s(u),"$elemMatch: invalid argument");for(var o=0;o<u.length;o++)if(i.test(u[o]))return[u[o]]},$slice:function(t,e,r){var u=In(t,r);return s(u)?s(e)?Un(u,e[0],e[1]):(n(a(e),"$slice: invalid arguments for projection"),Un(u,e)):u}},ut={$addFields:Y,$bucket:J,$bucketAuto:z,$count:H,$facet:V,$group:K,$limit:Q,$lookup:W,$match:G,$out:X,$project:Z,$redact:nn,$replaceRoot:tn,$sample:en,$skip:rn,$sort:un,$sortByCount:on,$unwind:an},it=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},ot=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),at=function(){function t(n){it(this,t),this.__operators=n}return ot(t,[{key:"run",value:function(t,e){return x(this.__operators)||M(this.__operators,function(r){var u=j(r);n(1===u.length&&m(wn("pipeline"),u[0]),"Invalid aggregation operator "+u),u=u[0],t=e&&e instanceof vt?ut[u].call(e,t,r[u]):ut[u](t,r[u])}),t}}]),t}(),st={$addToSet:cn,$avg:ln,$first:fn,$last:vn,$max:hn,$min:pn,$push:dn,$stdDevPop:$n,$stdDevSamp:gn,$sum:mn},ct=function(){function t(n,e,r){it(this,t),this.__query=e,this.__collection=n,this.__projection=r||e.__projection,this.__operators={},this.__result=!1,this.__position=0}return ot(t,[{key:"_fetch",value:function(){var t=this;if(!1!==this.__result)return this.__result;l(this.__projection)&&Object.assign(this.__operators,{$project:this.__projection}),n(s(this.__collection),"Input collection is not of valid type. Must be an Array."),this.__result=this.__collection.filter(this.__query.test,this.__query);var e=[];if(M(["$sort","$skip","$limit","$project"],function(n){if(k(t.__operators,n)){var r={};r[n]=t.__operators[n],e.push(r)}}),e.length>0){var r=new at(e);this.__result=r.run(this.__result,this.__query)}return this.__result}},{key:"all",value:function(){return this._fetch()}},{key:"first",value:function(){return this.count()>0?this._fetch()[0]:null}},{key:"last",value:function(){return this.count()>0?this._fetch()[this.count()-1]:null}},{key:"count",value:function(){return this._fetch().length}},{key:"skip",value:function(n){return Object.assign(this.__operators,{$skip:n}),this}},{key:"limit",value:function(n){return Object.assign(this.__operators,{$limit:n}),this}},{key:"sort",value:function(n){return Object.assign(this.__operators,{$sort:n}),this}},{key:"next",value:function(){return this.hasNext()?this._fetch()[this.__position++]:null}},{key:"hasNext",value:function(){return this.count()>this.__position}},{key:"map",value:function(n){return this._fetch().map(n)}},{key:"forEach",value:function(n){M(this._fetch(),n)}},{key:Symbol.iterator,value:function(){var n=this;return{next:function(){return n.hasNext()?{done:!1,value:n.next()}:{done:!0}}}}}]),t}(),lt={$eq:function(n,t){if(C(n,t))return!0;if(d(n)&&d(t))return!0;if(s(n)){var e=C.bind(null,t);return n.some(e)||S(n,1).some(e)}return!1},$ne:function(n,t){return!this.$eq(n,t)},$in:function(n,t){return E(O(n),t).length>0},$nin:function(n,t){return d(n)||!this.$in(n,t)},$lt:function(n,t){return!g(O(n).find(function(n){return yn(n,t)&&n<t}))},$lte:function(n,t){return!g(O(n).find(function(n){return yn(n,t)&&n<=t}))},$gt:function(n,t){return!g(O(n).find(function(n){return yn(n,t)&&n>t}))},$gte:function(n,t){return!g(O(n).find(function(n){return yn(n,t)&&n>=t}))},$mod:function(n,t){return!g(O(n).find(function(n){return a(n)&&s(t)&&2===t.length&&n%t[0]===t[1]}))},$regex:function(n,t){n=O(n);var e=function(n){return o(n)&&!!n.match(t)};return n.some(e)||S(n,1).some(e)},$exists:function(n,t){return(!1===t||0===t)&&d(n)||(!0===t||1===t)&&!d(n)},$all:function(n,t){var e=!1;if(s(n)&&s(t))for(var r=0,u=t.length;r<u;r++){if(!l(t[r])||!m(j(t[r]),"$elemMatch"))return E(t,n).length===u;e=e||this.$elemMatch(n,t[r].$elemMatch)}return e},$size:function(n,t){return s(n)&&a(t)&&n.length===t},$elemMatch:function(n,t){if(s(n)&&!x(n))for(var e=new vt(t),r=0,u=n.length;r<u;r++)if(e.test(n[r]))return!0;return!1},$type:function(n,t){switch(t){case 1:case"double":return a(n)&&-1!==(n+"").indexOf(".");case 2:case Hn:return o(n);case 3:case Wn:return l(n);case 4:case Qn:return s(n);case 6:case Yn:return d(n);case 8:case"bool":return i(n);case 9:case Vn:return v(n);case 10:case Fn:return $(n);case 11:case"regex":return h(n);case 16:case"int":return a(n)&&n<=2147483647&&-1===(n+"").indexOf(".");case 18:case"long":return a(n)&&n>2147483647&&n<=0x8000000000000000&&-1===(n+"").indexOf(".");case 19:case"decimal":return a(n);default:return!1}}},ft={$and:function(t,e){n(s(e),"Invalid expression: $and expects value to be an Array");var r=[];return M(e,function(n){return r.push(new vt(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(!r[t].test(n))return!1;return!0}}},$or:function(t,e){n(s(e),"Invalid expression. $or expects value to be an Array");var r=[];return M(e,function(n){return r.push(new vt(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(r[t].test(n))return!0;return!1}}},$nor:function(t,e){n(s(e),"Invalid expression. $nor expects value to be an Array");var r=this.$or("$or",e);return{test:function(n){return!r.test(n)}}},$not:function(n,t){var e={};e[n]=Tn(t);var r=new vt(e);return{test:function(n){return!r.test(n)}}},$where:function(n,t){return p(t)||(t=new Function("return "+t+";")),{test:function(n){return!0===t.call(n)}}}};M(lt,function(n,t){ft[t]=function(n,t){return function(e,r){return{test:function(u){var i=In(u,e,{meta:!0});return i=q(i.result,i.depth),n.call(t,i,r)}}}}(n,lt)});var vt=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};it(this,t),this.__criteria=n,this.__projection=e,this.__compiled=[],this._compile()}return ot(t,[{key:"_compile",value:function(){var t=this;if(!x(this.__criteria)){n(l(this.__criteria),"Criteria must be of type Object");var e=void 0;M(this.__criteria,function(n,r){"$where"===r?e={field:r,expr:n}:m(["$and","$or","$nor"],r)?t._processOperator(r,r,n):(n=Tn(n),M(n,function(n,e){t._processOperator(r,e,n)})),l(e)&&t._processOperator(e.field,e.field,e.expr)})}}},{key:"_processOperator",value:function(t,e,r){n(m(wn(et),e),"Invalid query operator '"+e+"' detected"),this.__compiled.push(ft[e](t,r))}},{key:"test",value:function(n){for(var t=0,e=this.__compiled.length;t<e;t++)if(!this.__compiled[t].test(n))return!1;return!0}},{key:"find",value:function(n,t){return new ct(n,this,t)}},{key:"remove",value:function(n){var t=this;return A(n,function(n,e){return t.test(e)||n.push(e),n},[])}}]),t}(),ht={$abs:function(n,t){var e=Rn(n,t);return null===e||void 0===e?null:Math.abs(e)},$add:function(n,t){return A(Rn(n,t),function(n,t){return n+t},0)},$ceil:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)||isNaN(r),"$ceil must be a valid expression that resolves to a number."),Math.ceil(r))},$divide:function(n,t){var e=Rn(n,t);return e[0]/e[1]},$exp:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)||isNaN(r),"$exp must be a valid expression that resolves to a number."),Math.exp(r))},$floor:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)||isNaN(r),"$floor must be a valid expression that resolves to a number."),Math.floor(r))},$ln:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)||isNaN(r),"$ln must be a valid expression that resolves to a number."),Math.log(r))},$log:function(t,e){var r=Rn(t,e);return n(s(r)&&2===r.length,"$log must be a valid expression that resolves to an array of 2 items"),r.some(d)?null:(n(r.some(isNaN)||r.every(a),"$log expression must resolve to array of 2 numbers"),Math.log10(r[0])/Math.log10(r[1]))},$log10:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)||isNaN(r),"$log10 must be a valid expression that resolves to a number."),Math.log10(r))},$mod:function(n,t){var e=Rn(n,t);return e[0]%e[1]},$multiply:function(n,t){return A(Rn(n,t),function(n,t){return n*t},1)},$pow:function(t,e){var r=Rn(t,e);return n(s(r)&&2===r.length&&r.every(a),"$pow expression must resolve to an array of 2 numbers"),n(!(0===r[0]&&r[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(r[0],r[1])},$sqrt:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)&&r>0||isNaN(r),"$sqrt expression must resolve to non-negative number."),Math.sqrt(r))},$subtract:function(n,t){var e=Rn(n,t);return e[0]-e[1]},$trunc:function(t,e){var r=Rn(t,e);return d(r)?null:(n(a(r)||isNaN(r),"$trunc expression must resolve to a number."),Math.trunc(r))}},pt={$arrayElemAt:function(t,e){var r=Rn(t,e);n(s(r)&&2===r.length,"$arrayElemAt expression must resolve to an array of 2 elements"),n(s(r[0]),"First operand to $arrayElemAt must resolve to an array"),n(a(r[1]),"Second operand to $arrayElemAt must resolve to an integer");var u=r[1];return r=r[0],u<0&&Math.abs(u)<=r.length?r[u+r.length]:u>=0&&u<r.length?r[u]:void 0},$arrayToObject:function(t,e){var r=Rn(t,e);return n(s(r),"$arrayToObject expression must resolve to an array"),A(r,function(t,e){return s(e)&&2==e.length?t[e[0]]=e[1]:(n(l(e)&&k(e,"k")&&k(e,"v"),"$arrayToObject expression is invalid."),t[e.k]=e.v),t},{})},$concatArrays:function(t,e){var r=Rn(t,e,null);return n(s(r),"$concatArrays must resolve to an array"),r.some(d)?null:r.reduce(function(n,t){return L(n,t)},[])},$filter:function(t,e){var r=Rn(t,e.input),u=e.as,i=e.cond;return n(s(r),"$filter 'input' expression must resolve to an array"),r.filter(function(n){var t={};return t["$"+u]=n,!0===Rn(t,i)})},$in:function(t,e){var r=Rn(t,e[0]),u=Rn(t,e[1]);return n(s(u),"$in second argument must be an array"),m(u,r)},$indexOfArray:function(t,e){var r=Rn(t,e);if(d(r))return null;var u=r[0],i=r[1];if(d(u))return null;n(s(u),"$indexOfArray expression must resolve to an array.");var o=r[2]||0,a=r[3];return d(a)&&(a=u.length),o>a?-1:(n(o>=0&&a>=0,"$indexOfArray expression is invalid"),(o>0||a<u.length)&&(u=u.slice(o,a)),u.findIndex(C.bind(null,i))+o)},$isArray:function(n,t){return s(Rn(n,t[0]))},$map:function(t,e){var r=Rn(t,e.input);n(s(r),"$map 'input' expression must resolve to an array");var u=e.as,i=e.in,o="$"+u;return N(r,function(n){return t[o]=n,Rn(t,i)})},$objectToArray:function(t,e){var r=Rn(t,e);n(l(r),"$objectToArray expression must resolve to an object");var u=[];return M(r,function(n,t){return u.push({k:t,v:n})}),u},$range:function(n,t){for(var e=Rn(n,t),r=e[0],u=e[1],i=e[2]||1,o=[];r<u&&i>0||r>u&&i<0;)o.push(r),r+=i;return o},$reduce:function(t,e){var r=Rn(t,e.input),u=Rn(t,e.initialValue),i=e.in;return d(r)?null:(n(s(r),"$reduce 'input' expression must resolve to an array"),A(r,function(n,t){return Rn({$value:n,$this:t},i)},u))},$reverseArray:function(t,e){var r=Rn(t,e);if(d(r))return null;n(s(r),"$reverseArray expression must resolve to an array");var u=[];return L(u,r),u.reverse(),u},$size:function(n,t){var e=Rn(n,t);return s(e)?e.length:void 0},$slice:function(n,t){var e=Rn(n,t);return Un(e[0],e[1],e[2])},$zip:function(t,e){var r=Rn(t,e.inputs),u=e.useLongestLength||!1;n(s(r),"'inputs' expression must resolve to an array"),n(i(u),"'useLongestLength' must be a boolean"),s(e.defaults)&&n(b(u),"'useLongestLength' must be set to true to use 'defaults'");for(var o=0,a=0,c=r.length;a<c;a++){var l=r[a];if(d(l))return null;n(s(l),"'inputs' expression values must resolve to an array or null"),o=u?Math.max(o,l.length):Math.min(o||l.length,l.length)}for(var f=[],v=e.defaults||[],h=0;h<o;h++)!function(n){var t=r.map(function(t,e){return d(t[n])?v[e]||null:t[n]});f.push(t)}(h);return f}},dt={$and:function(n,t){var e=Rn(n,t);return b(e)&&e.every(b)},$or:function(n,t){var e=Rn(n,t);return b(e)&&e.some(b)},$not:function(n,t){return!Rn(n,t[0])}},$t={$cmp:function(n,t){var e=Rn(n,t);return e[0]>e[1]?1:e[0]<e[1]?-1:0}};M(["$eq","$ne","$gt","$gte","$lt","$lte","$nin"],function(n){$t[n]=function(t,e){var r=Rn(t,e);return lt[n](r[0],r[1])}});var gt={$cond:function(t,e){var r=void 0,u=void 0,i=void 0;return s(e)?(n(3===e.length,"$cond: invalid arguments"),r=e[0],u=e[1],i=e[2]):(n(l(e),"$cond: invalid arguments"),r=e.if,u=e.then,i=e.else),Rn(t,r)?Rn(t,u):Rn(t,i)},$switch:function(t,e){var r="Invalid arguments for $switch operator";n(e.branches,r);var u=e.branches.find(function(e){return n(e.case&&e.then,r),Rn(t,e.case)});return u?Rn(t,u.then):(n(e.default,r),Rn(t,e.default))},$ifNull:function(t,e){n(s(e)&&2===e.length,"Invalid arguments for $ifNull operator");var r=Rn(t,e);return d(r[0])?r[1]:r[0]}},mt={"%Y":["$year",4],"%m":["$month",2],"%d":["$dayOfMonth",2],"%H":["$hour",2],"%M":["$minute",2],"%S":["$second",2],"%L":["$millisecond",3],"%j":["$dayOfYear",3],"%w":["$dayOfWeek",1],"%U":["$week",2],"%%":"%"},yt={$dayOfYear:function(n,t){var e=Rn(n,t),r=new Date(e.getFullYear(),0,0),u=e-r;return Math.round(u/864e5)},$dayOfMonth:function(n,t){return Rn(n,t).getDate()},$dayOfWeek:function(n,t){return Rn(n,t).getDay()+1},$year:function(n,t){return Rn(n,t).getFullYear()},$month:function(n,t){return Rn(n,t).getMonth()+1},$week:function(n,t){var e=Rn(n,t);e=new Date(+e),e.setHours(0,0,0),e.setDate(e.getDate()+4-(e.getDay()||7));var r=new Date(e.getFullYear(),0,1);return Math.floor(((e-r)/864e5+1)/7)},$hour:function(n,t){return Rn(n,t).getUTCHours()},$minute:function(n,t){return Rn(n,t).getMinutes()},$second:function(n,t){return Rn(n,t).getSeconds()},$millisecond:function(n,t){return Rn(n,t).getMilliseconds()},$dateToString:function(n,t){for(var e=t.format,r=Rn(n,t.date),u=e.match(/(%%|%Y|%m|%d|%H|%M|%S|%L|%j|%w|%U)/g),i=0,o=u.length;i<o;i++){var a=mt[u[i]],c=a;if(s(a)){var l=this[a[0]],f=a[1];c=xn(l.call(this,n,r),f)}e=e.replace(u[i],c)}return e}},bt={$literal:function(n,t){return t}},_t={$setEquals:function(n,t){var e=Rn(n,t),r=P(e[0]),u=P(e[1]);return r.length===u.length&&r.length===E(r,u).length},$setIntersection:function(n,t){var e=Rn(n,t);return E(e[0],e[1])},$setDifference:function(n,t){var e=Rn(n,t);return e[0].filter(y.bind(null,e[1]))},$setUnion:function(n,t){var e=Rn(n,t);return I(e[0],e[1])},$setIsSubset:function(n,t){var e=Rn(n,t);return E(e[0],e[1]).length===e[0].length},$anyElementTrue:function(n,t){return Rn(n,t)[0].some(b)},$allElementsTrue:function(n,t){return Rn(n,t)[0].every(b)}},xt={$concat:function(n,t){var e=Rn(n,t);return[null,void 0].some(m.bind(null,e))?null:e.join("")},$indexOfBytes:function(t,e){var r=Rn(t,e),u="$indexOfBytes: expression resolves to invalid arguments";if(d(r[0]))return null;n(o(r[0])&&o(r[1]),u);var i=r[0],s=r[1],c=r[2],l=r[3],f=d(c)||a(c)&&c>=0&&Math.round(c)===c;if(f=f&&(d(l)||a(l)&&l>=0&&Math.round(l)===l),n(f,u),c=c||0,l=l||i.length,c>l)return-1;var v=i.substring(c,l).indexOf(s);return v>-1?v+c:v},$split:function(t,e){var r=Rn(t,e);return d(r[0])?null:(n(r.every(o),"$split: invalid argument"),r[0].split(r[1]))},$strLenBytes:function(n,t){return~-encodeURI(Rn(n,t)).split(/%..|./).length},$strLenCP:function(n,t){return Rn(n,t).length},$strcasecmp:function(t,e){var r=Rn(t,e),u=r[0],i=r[1];return C(u,i)||r.every(d)?0:(n(r.every(o),"$strcasecmp: invalid argument"),u=u.toUpperCase(),i=i.toUpperCase(),u>i&&1||u<i&&-1||0)},$substrBytes:function(t,e){var r=Rn(t,e),u=r[0],i=r[1],s=r[2];n(o(u)&&a(i)&&i>=0&&a(s)&&s>=0,"$substrBytes: invalid arguments");for(var c=kn(u),l=[],f=0,v=0;v<c.length;v++)l.push(f),f+=c[v].length;var h=l.indexOf(i),p=l.indexOf(i+s);return n(h>-1&&p>-1,"$substrBytes: Invalid range, start or end index is a UTF-8 continuation byte."),u.substring(h,p)},$substr:function(n,t){var e=Rn(n,t),r=e[0],u=e[1],i=e[2];return o(r)?u<0?"":i<0?r.substr(u):r.substr(u,i):""},$substrCP:function(n,t){return this.$substr(n,t)},$toLower:function(n,t){var e=Rn(n,t);return x(e)?"":e.toLowerCase()},$toUpper:function(n,t){var e=Rn(n,t);return x(e)?"":e.toUpperCase()}},Ot=[192,224,240],kt={$let:function(n,t){var e=t.vars,r=t.in;return M(j(e),function(t){var r=Rn(n,e[t]);n["$"+t]=r}),Rn(n,r)}},wt=Object.assign({},ht,pt,dt,$t,gt,yt,bt,_t,xt,kt),jt={expression:wt,group:st,pipeline:ut,projection:rt,query:ft},Mt={key:"_id"},Nt={$$ROOT:function(n,t,e){return e.root},$$CURRENT:function(n,t,e){return n}},At={$$KEEP:function(n){return n},$$PRUNE:function(){},$$DESCEND:function(n,t,e){if(!k(t,"$cond"))return n;var r=void 0;return M(n,function(u,i){f(u)&&(s(u)?(r=[],M(u,function(n){l(n)&&(n=Ln(n,t,e)),d(n)||r.push(n)})):r=Ln(u,t,e),d(r)?delete n[i]:n[i]=r)}),n}},Et=j(Nt),It=j(At);return{_internal:Bn,Aggregator:at,CollectionMixin:{query:function(n,t){return new vt(n).find(this.toJSON(),t)},aggregate:function(n){return new at(n).run(this.toJSON())}},Cursor:ct,OP_EXPRESSION:Zn,OP_GROUP:nt,OP_PIPELINE:"pipeline",OP_PROJECTION:tt,OP_QUERY:et,Query:vt,VERSION:"2.0.3",addOperators:jn,aggregate:sn,find:bn,remove:_n,setup:Mn}});
//# sourceMappingURL=dist/mingo.min.map
